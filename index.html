
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLS Data Explorer</title>
<style>
  :root {
    --blue-900: #1a2744;
    --blue-700: #1e3a5f;
    --blue-600: #2563eb;
    --blue-500: #3b82f6;
    --blue-100: #dbeafe;
    --blue-50: #eff6ff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --green-600: #16a34a;
    --red-500: #ef4444;
    --amber-500: #f59e0b;
    --amber-50: #fffbeb;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--gray-50);
    color: var(--gray-800);
    line-height: 1.5;
  }

  header {
    background: linear-gradient(135deg, var(--blue-900), var(--blue-700));
    color: white;
    padding: 2rem 2rem 1.5rem;
  }

  header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
  header p { color: var(--blue-100); font-size: 0.95rem; }

  .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }

  /* Search Section */
  .search-section {
    padding: 2rem 0 1rem;
  }
  .search-box {
    position: relative;
    max-width: 800px;
    margin: 0 auto;
  }
  .search-box input {
    width: 100%;
    padding: 1rem 1.25rem 1rem 3rem;
    font-size: 1.1rem;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    background: white;
    transition: border-color 0.2s;
    outline: none;
  }
  .search-box input:focus { border-color: var(--blue-500); }
  .search-box .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
    font-size: 1.2rem;
  }
  .search-hint {
    text-align: center;
    color: var(--gray-500);
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  /* Filters Row */
  .filters {
    display: flex;
    gap: 1rem;
    max-width: 800px;
    margin: 1rem auto 0;
    flex-wrap: wrap;
    align-items: end;
  }
  .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
  .filter-group label { font-size: 0.8rem; font-weight: 600; color: var(--gray-600); }
  .filter-group select, .filter-group input[type="number"] {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
  }
  .filter-group select { min-width: 180px; }
  .filter-group input[type="number"] { width: 90px; }
  .btn-search {
    padding: 0.5rem 1.5rem;
    background: var(--blue-600);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-search:hover { background: var(--blue-500); }
  .btn-search:disabled { background: var(--gray-300); cursor: not-allowed; }

  /* Quick Searches */
  .quick-searches {
    max-width: 800px;
    margin: 1.5rem auto 0;
  }
  .quick-searches h3 { font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem; font-weight: 600; }
  .quick-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .quick-tag {
    padding: 0.35rem 0.85rem;
    background: var(--blue-50);
    color: var(--blue-600);
    border: 1px solid var(--blue-100);
    border-radius: 20px;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .quick-tag:hover { background: var(--blue-100); }

  /* Results Area */
  .results-section { padding: 1.5rem 0 3rem; }
  .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
  .results-header h2 { font-size: 1.2rem; color: var(--gray-700); }

  /* Match Cards */
  .match-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    margin-bottom: 1rem;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .match-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  .match-card-header {
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  .match-card-header:hover { background: var(--gray-50); }
  .match-info h3 { font-size: 1rem; font-weight: 600; color: var(--gray-800); }
  .match-info p { font-size: 0.85rem; color: var(--gray-500); margin-top: 0.15rem; }
  .match-badges { display: flex; gap: 0.4rem; align-items: center; }
  .badge {
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .badge-source { background: var(--blue-50); color: var(--blue-600); }
  .badge-geo { background: #fef3c7; color: #92400e; }
  .badge-freq { background: #f0fdf4; color: var(--green-600); }

  .btn-fetch {
    padding: 0.4rem 1rem;
    background: var(--green-600);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    margin-left: 0.75rem;
    white-space: nowrap;
  }
  .btn-fetch:hover { opacity: 0.9; }
  .btn-fetch:disabled { background: var(--gray-300); }

  /* Data Table */
  .data-panel {
    border-top: 1px solid var(--gray-200);
    padding: 1rem 1.25rem;
    display: none;
  }
  .data-panel.open { display: block; }
  .data-panel-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  .btn-csv {
    padding: 0.35rem 0.85rem;
    background: white;
    color: var(--gray-600);
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
  }
  .btn-csv:hover { background: var(--gray-50); }

  .data-table-wrapper { overflow-x: auto; }
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
  }
  .data-table th {
    background: var(--gray-50);
    padding: 0.6rem 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--gray-600);
    border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }
  .data-table th:hover { color: var(--blue-600); }
  .data-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--gray-100);
    color: var(--gray-700);
  }
  .data-table tr:hover td { background: var(--blue-50); }

  /* Loading / Error States */
  .loading {
    text-align: center;
    padding: 2rem;
    color: var(--gray-500);
  }
  .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--blue-500);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 0.5rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    background: #fef2f2;
    color: #991b1b;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.88rem;
    margin-top: 0.5rem;
  }

  .info-box {
    background: var(--amber-50);
    border: 1px solid #fde68a;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    color: #92400e;
    margin-bottom: 1rem;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-400);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
  .empty-state p { font-size: 1rem; }

  .series-id-display {
    font-family: monospace;
    font-size: 0.78rem;
    color: var(--gray-400);
    margin-top: 0.25rem;
  }

  @media (max-width: 768px) {
    header { padding: 1.5rem 1rem; }
    .filters { flex-direction: column; }
    .filter-group select { min-width: 100%; }
  }
</style>
</head>
<body>

<header>
  <div class="container">
    <h1>BLS Data Explorer</h1>
    <p>Search labor market data in plain English &mdash; powered by the Bureau of Labor Statistics API</p>
  </div>
</header>

<div class="search-section">
  <div class="container">
    <div class="search-box">
      <span class="search-icon">&#128269;</span>
      <input type="text" id="searchInput" placeholder='Try: "unemployment rate in Texas" or "average wages for nurses"' />
    </div>
    <div class="search-hint">Type what you're looking for in everyday language. Include a state name for state-level data.</div>

    <div class="filters">
      <div class="filter-group">
        <label for="stateSelect">State</label>
        <select id="stateSelect">
          <option value="">National (All U.S.)</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="startYear">Start Year</label>
        <input type="number" id="startYear" min="2000" max="2026" value="2019" />
      </div>
      <div class="filter-group">
        <label for="endYear">End Year</label>
        <input type="number" id="endYear" min="2000" max="2026" value="2025" />
      </div>
      <button class="btn-search" id="searchBtn" onclick="runSearch()">Search</button>
    </div>

    <div class="quick-searches">
      <h3>COMMON SEARCHES</h3>
      <div class="quick-tags">
        <span class="quick-tag" onclick="quickSearch('unemployment rate')">Unemployment Rate</span>
        <span class="quick-tag" onclick="quickSearch('labor force participation')">Labor Force Participation</span>
        <span class="quick-tag" onclick="quickSearch('nonfarm payroll employment')">Nonfarm Payrolls</span>
        <span class="quick-tag" onclick="quickSearch('average hourly earnings')">Avg. Hourly Earnings</span>
        <span class="quick-tag" onclick="quickSearch('consumer price index')">CPI / Inflation</span>
        <span class="quick-tag" onclick="quickSearch('occupational wages')">Occupational Wages (OEWS)</span>
        <span class="quick-tag" onclick="quickSearch('job openings')">Job Openings (JOLTS)</span>
        <span class="quick-tag" onclick="quickSearch('employment by industry')">Employment by Industry</span>
        <span class="quick-tag" onclick="quickSearch('weekly earnings')">Weekly Earnings</span>
        <span class="quick-tag" onclick="quickSearch('employment cost index')">Employment Cost Index</span>
      </div>
    </div>
  </div>
</div>

<div class="results-section">
  <div class="container">
    <div id="resultsArea">
      <div class="empty-state">
        <div class="icon">&#128202;</div>
        <p>Search for labor market data above to get started</p>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE FIPS CODES
// ============================================================
const STATES = {
  "AL":"01","AK":"02","AZ":"04","AR":"05","CA":"06","CO":"08","CT":"09",
  "DE":"10","DC":"11","FL":"12","GA":"13","HI":"15","ID":"16","IL":"17",
  "IN":"18","IA":"19","KS":"20","KY":"21","LA":"22","ME":"23","MD":"24",
  "MA":"25","MI":"26","MN":"27","MS":"28","MO":"29","MT":"30","NE":"31",
  "NV":"32","NH":"33","NJ":"34","NM":"35","NY":"36","NC":"37","ND":"38",
  "OH":"39","OK":"40","OR":"41","PA":"42","RI":"44","SC":"45","SD":"46",
  "TN":"47","TX":"48","UT":"49","VT":"50","VA":"51","WA":"53","WV":"54",
  "WI":"55","WY":"56"
};

const STATE_NAMES = {
  "alabama":"AL","alaska":"AK","arizona":"AZ","arkansas":"AR","california":"CA",
  "colorado":"CO","connecticut":"CT","delaware":"DE","district of columbia":"DC",
  "florida":"FL","georgia":"GA","hawaii":"HI","idaho":"ID","illinois":"IL",
  "indiana":"IN","iowa":"IA","kansas":"KS","kentucky":"KY","louisiana":"LA",
  "maine":"ME","maryland":"MD","massachusetts":"MA","michigan":"MI","minnesota":"MN",
  "mississippi":"MS","missouri":"MO","montana":"MT","nebraska":"NE","nevada":"NV",
  "new hampshire":"NH","new jersey":"NJ","new mexico":"NM","new york":"NY",
  "north carolina":"NC","north dakota":"ND","ohio":"OH","oklahoma":"OK",
  "oregon":"OR","pennsylvania":"PA","rhode island":"RI","south carolina":"SC",
  "south dakota":"SD","tennessee":"TN","texas":"TX","utah":"UT","vermont":"VT",
  "virginia":"VA","washington":"WA","west virginia":"WV","wisconsin":"WI","wyoming":"WY"
};

// ============================================================
// DATA CATALOG — each entry maps natural language to BLS series
// ============================================================
const DATA_CATALOG = [
  // --- LAUS (Local Area Unemployment Statistics) ---
  {
    id: "unemployment_rate",
    name: "Unemployment Rate",
    source: "LAUS",
    sourceLabel: "Local Area Unemployment Statistics",
    description: "Monthly unemployment rate (seasonally adjusted at national level)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["unemployment","unemployment rate","jobless","jobless rate","unemployed","out of work","u-3","u3"],
    national: { seriesIds: ["LNS14000000"], labels: ["Unemployment Rate (SA)"] },
    state: (fips) => ({
      seriesIds: [`LASST${fips}0000000000003`],
      labels: ["Unemployment Rate (SA)"]
    })
  },
  {
    id: "unemployment_level",
    name: "Unemployment Level",
    source: "LAUS",
    sourceLabel: "Local Area Unemployment Statistics",
    description: "Number of unemployed persons (thousands at national level)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["unemployment level","number unemployed","unemployed persons","unemployed count"],
    national: { seriesIds: ["LNS13000000"], labels: ["Unemployment Level (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`LASST${fips}0000000000004`],
      labels: ["Unemployment Level (SA)"]
    })
  },
  {
    id: "employment_level",
    name: "Employment Level",
    source: "LAUS",
    sourceLabel: "Local Area Unemployment Statistics",
    description: "Number of employed persons",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["employment level","employed","employed persons","number employed","total employment"],
    national: { seriesIds: ["LNS12000000"], labels: ["Employment Level (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`LASST${fips}0000000000005`],
      labels: ["Employment Level (SA)"]
    })
  },
  {
    id: "labor_force",
    name: "Civilian Labor Force",
    source: "LAUS",
    sourceLabel: "Local Area Unemployment Statistics",
    description: "Total civilian labor force (employed + unemployed)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["labor force","labour force","civilian labor force","labor force level","workforce size","workforce"],
    national: { seriesIds: ["LNS11000000"], labels: ["Civilian Labor Force (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`LASST${fips}0000000000006`],
      labels: ["Civilian Labor Force (SA)"]
    })
  },
  {
    id: "lfpr",
    name: "Labor Force Participation Rate",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Percent of civilian noninstitutional population in the labor force",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["labor force participation","participation rate","lfpr","labour force participation","workforce participation"],
    national: { seriesIds: ["LNS11300000"], labels: ["LFPR (SA, %)"] }
  },
  {
    id: "epop",
    name: "Employment-Population Ratio",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Employed as a percent of the civilian noninstitutional population",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["employment population ratio","epop","employment to population","emp pop","e-pop"],
    national: { seriesIds: ["LNS12300000"], labels: ["Emp-Pop Ratio (SA, %)"] }
  },
  // --- CES (Current Employment Statistics) ---
  {
    id: "nonfarm_payrolls",
    name: "Total Nonfarm Payroll Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Total nonfarm employment from the establishment survey (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["nonfarm payrolls","nonfarm employment","payroll employment","total nonfarm","nfp","jobs report","job growth","payrolls","establishment survey"],
    national: { seriesIds: ["CES0000000001"], labels: ["Total Nonfarm (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000000000001`],
      labels: ["Total Nonfarm (SA, thousands)"]
    })
  },
  {
    id: "private_employment",
    name: "Total Private Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Total private sector employment (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["private employment","private sector jobs","private payrolls","private sector employment"],
    national: { seriesIds: ["CES0500000001"], labels: ["Total Private (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000005000001`],
      labels: ["Total Private (SA, thousands)"]
    })
  },
  {
    id: "avg_hourly_earnings",
    name: "Average Hourly Earnings (All Private)",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Average hourly earnings of all employees on private nonfarm payrolls",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["average hourly earnings","hourly wage","hourly wages","hourly pay","average wage","avg hourly","ahe","wage growth","earnings growth"],
    national: { seriesIds: ["CES0500000003"], labels: ["Avg Hourly Earnings, All Private (SA, $)"] }
  },
  {
    id: "avg_weekly_hours",
    name: "Average Weekly Hours (All Private)",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Average weekly hours of all employees on private nonfarm payrolls",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["average weekly hours","weekly hours","hours worked","work hours","average hours"],
    national: { seriesIds: ["CES0500000002"], labels: ["Avg Weekly Hours, All Private (SA)"] }
  },
  {
    id: "avg_weekly_earnings",
    name: "Average Weekly Earnings (All Private)",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Average weekly earnings of all employees on private nonfarm payrolls",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["weekly earnings","average weekly earnings","weekly pay","weekly wage"],
    national: { seriesIds: ["CES0500000011"], labels: ["Avg Weekly Earnings, All Private (SA, $)"] }
  },
  // --- CES Industry Breakdowns ---
  {
    id: "manufacturing_employment",
    name: "Manufacturing Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in the manufacturing sector (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["manufacturing","manufacturing employment","manufacturing jobs","factory jobs","factory employment"],
    national: { seriesIds: ["CES3000000001"], labels: ["Manufacturing Employment (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000003000001`],
      labels: ["Manufacturing Employment (SA, thousands)"]
    })
  },
  {
    id: "healthcare_employment",
    name: "Health Care Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in health care and social assistance (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["healthcare","health care","healthcare employment","hospital","medical","nursing","health care jobs","healthcare jobs"],
    national: { seriesIds: ["CES6562000001"], labels: ["Health Care & Social Assistance (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000006562001`],
      labels: ["Health Care & Social Assistance (SA, thousands)"]
    })
  },
  {
    id: "construction_employment",
    name: "Construction Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in the construction industry (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["construction","construction employment","construction jobs","building","construction industry"],
    national: { seriesIds: ["CES2000000001"], labels: ["Construction Employment (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000002000001`],
      labels: ["Construction Employment (SA, thousands)"]
    })
  },
  {
    id: "retail_employment",
    name: "Retail Trade Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in retail trade (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["retail","retail employment","retail trade","retail jobs","store jobs"],
    national: { seriesIds: ["CES4200000001"], labels: ["Retail Trade Employment (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000004200001`],
      labels: ["Retail Trade Employment (SA, thousands)"]
    })
  },
  {
    id: "tech_employment",
    name: "Information / Tech Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in the information sector (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["technology","tech","information","tech employment","tech jobs","it jobs","software","information sector"],
    national: { seriesIds: ["CES5000000001"], labels: ["Information Sector Employment (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000005000001`],
      labels: ["Information Sector Employment (SA, thousands)"]
    })
  },
  {
    id: "government_employment",
    name: "Government Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Total government employment, all levels (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["government","government employment","government jobs","public sector","federal","state government","local government"],
    national: { seriesIds: ["CES9000000001"], labels: ["Government Employment (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000009000001`],
      labels: ["Government Employment (SA, thousands)"]
    })
  },
  {
    id: "leisure_employment",
    name: "Leisure & Hospitality Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in leisure and hospitality (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["leisure","hospitality","leisure and hospitality","restaurant","hotel","tourism","food service","accommodation","entertainment"],
    national: { seriesIds: ["CES7000000001"], labels: ["Leisure & Hospitality (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000007000001`],
      labels: ["Leisure & Hospitality (SA, thousands)"]
    })
  },
  {
    id: "education_employment",
    name: "Education Services Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Private education services employment (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["education","education employment","schools","teachers","education services","teaching"],
    national: { seriesIds: ["CES6561000001"], labels: ["Private Education Services (SA, thousands)"] }
  },
  {
    id: "finance_employment",
    name: "Financial Activities Employment",
    source: "CES",
    sourceLabel: "Current Employment Statistics",
    description: "Employment in financial activities (thousands)",
    frequency: "Monthly",
    stateLevel: true,
    keywords: ["finance","financial","banking","insurance","financial activities","financial services","financial employment"],
    national: { seriesIds: ["CES5500000001"], labels: ["Financial Activities (SA, thousands)"] },
    state: (fips) => ({
      seriesIds: [`SMU${fips}000005500001`],
      labels: ["Financial Activities (SA, thousands)"]
    })
  },
  // --- CPI ---
  {
    id: "cpi_all",
    name: "Consumer Price Index (CPI-U), All Items",
    source: "CPI",
    sourceLabel: "Consumer Price Index",
    description: "CPI for all urban consumers, all items (1982-84=100)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["cpi","consumer price index","inflation","price level","cost of living","prices","cpi-u"],
    national: { seriesIds: ["CUUR0000SA0"], labels: ["CPI-U All Items (SA, 1982-84=100)"] }
  },
  {
    id: "cpi_food",
    name: "CPI: Food",
    source: "CPI",
    sourceLabel: "Consumer Price Index",
    description: "CPI for food and beverages",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["cpi food","food prices","food inflation","grocery prices","food cost"],
    national: { seriesIds: ["CUUR0000SAF1"], labels: ["CPI Food & Beverages (NSA)"] }
  },
  {
    id: "cpi_energy",
    name: "CPI: Energy",
    source: "CPI",
    sourceLabel: "Consumer Price Index",
    description: "CPI for energy (gas, electricity, etc.)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["cpi energy","energy prices","gas prices","energy inflation","fuel prices","gasoline"],
    national: { seriesIds: ["CUUR0000SA0E"], labels: ["CPI Energy (SA)"] }
  },
  {
    id: "cpi_shelter",
    name: "CPI: Shelter / Housing",
    source: "CPI",
    sourceLabel: "Consumer Price Index",
    description: "CPI for shelter (rent, owners equivalent rent)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["cpi shelter","housing costs","rent","housing inflation","shelter inflation","housing prices","rent inflation","oer","owners equivalent rent"],
    national: { seriesIds: ["CUUR0000SAH1"], labels: ["CPI Shelter (NSA)"] }
  },
  {
    id: "core_cpi",
    name: "Core CPI (All Items Less Food & Energy)",
    source: "CPI",
    sourceLabel: "Consumer Price Index",
    description: "CPI excluding food and energy",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["core cpi","core inflation","cpi less food and energy","underlying inflation","cpi ex food energy"],
    national: { seriesIds: ["CUUR0000SA0L1E"], labels: ["Core CPI (NSA, 1982-84=100)"] }
  },
  // --- JOLTS ---
  {
    id: "jolts_openings",
    name: "Job Openings (JOLTS)",
    source: "JOLTS",
    sourceLabel: "Job Openings and Labor Turnover Survey",
    description: "Total nonfarm job openings (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["job openings","jolts","open positions","vacancies","job vacancies","openings","help wanted"],
    national: { seriesIds: ["JTS000000000000000JOL"], labels: ["Job Openings, Total Nonfarm (SA, thousands)"] }
  },
  {
    id: "jolts_hires",
    name: "Hires (JOLTS)",
    source: "JOLTS",
    sourceLabel: "Job Openings and Labor Turnover Survey",
    description: "Total nonfarm hires (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["hires","hiring","jolts hires","new hires","hiring rate"],
    national: { seriesIds: ["JTS000000000000000HIL"], labels: ["Hires, Total Nonfarm (SA, thousands)"] }
  },
  {
    id: "jolts_separations",
    name: "Total Separations (JOLTS)",
    source: "JOLTS",
    sourceLabel: "Job Openings and Labor Turnover Survey",
    description: "Total nonfarm separations (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["separations","jolts separations","turnover","total separations"],
    national: { seriesIds: ["JTS000000000000000TSL"], labels: ["Total Separations (SA, thousands)"] }
  },
  {
    id: "jolts_quits",
    name: "Quits (JOLTS)",
    source: "JOLTS",
    sourceLabel: "Job Openings and Labor Turnover Survey",
    description: "Total nonfarm quits (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["quits","quit rate","jolts quits","voluntary separations","great resignation","quitting"],
    national: { seriesIds: ["JTS000000000000000QUL"], labels: ["Quits, Total Nonfarm (SA, thousands)"] }
  },
  {
    id: "jolts_layoffs",
    name: "Layoffs & Discharges (JOLTS)",
    source: "JOLTS",
    sourceLabel: "Job Openings and Labor Turnover Survey",
    description: "Total nonfarm layoffs and discharges (thousands)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["layoffs","discharges","jolts layoffs","fired","terminations","layoff","rif"],
    national: { seriesIds: ["JTS000000000000000LDL"], labels: ["Layoffs & Discharges (SA, thousands)"] }
  },
  // --- ECI ---
  {
    id: "eci_total",
    name: "Employment Cost Index (Total Compensation)",
    source: "ECI",
    sourceLabel: "Employment Cost Index",
    description: "Quarterly change in employer costs for employee compensation",
    frequency: "Quarterly",
    stateLevel: false,
    keywords: ["employment cost index","eci","compensation cost","total compensation","employer costs","labor cost","labor costs","labour costs"],
    national: { seriesIds: ["CIS1010000000000A"], labels: ["ECI Total Compensation (SA, Dec 2005=100)"] }
  },
  {
    id: "eci_wages",
    name: "Employment Cost Index (Wages & Salaries)",
    source: "ECI",
    sourceLabel: "Employment Cost Index",
    description: "Quarterly change in employer costs for wages and salaries",
    frequency: "Quarterly",
    stateLevel: false,
    keywords: ["eci wages","wage index","salary index","wage cost index","wage growth index"],
    national: { seriesIds: ["CIS1020000000000A"], labels: ["ECI Wages & Salaries (SA, Dec 2005=100)"] }
  },
  // --- PPI ---
  {
    id: "ppi_final_demand",
    name: "Producer Price Index (Final Demand)",
    source: "PPI",
    sourceLabel: "Producer Price Index",
    description: "PPI for final demand, all commodities",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["ppi","producer price index","producer prices","wholesale prices","producer inflation"],
    national: { seriesIds: ["WPSFD4"], labels: ["PPI Final Demand (SA)"] }
  },
  // --- CPS Demographics ---
  {
    id: "unemp_rate_men",
    name: "Unemployment Rate: Men (20+)",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for men 20 years and over",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["male unemployment","men unemployment","unemployment men","unemployment rate men","male jobless"],
    national: { seriesIds: ["LNS14000025"], labels: ["Unemployment Rate, Men 20+ (SA, %)"] }
  },
  {
    id: "unemp_rate_women",
    name: "Unemployment Rate: Women (20+)",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for women 20 years and over",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["female unemployment","women unemployment","unemployment women","unemployment rate women","female jobless"],
    national: { seriesIds: ["LNS14000026"], labels: ["Unemployment Rate, Women 20+ (SA, %)"] }
  },
  {
    id: "unemp_rate_black",
    name: "Unemployment Rate: Black or African American",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for Black or African American workers",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["black unemployment","african american unemployment","black jobless","race unemployment black"],
    national: { seriesIds: ["LNS14000006"], labels: ["Unemployment Rate, Black (SA, %)"] }
  },
  {
    id: "unemp_rate_hispanic",
    name: "Unemployment Rate: Hispanic or Latino",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for Hispanic or Latino workers",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["hispanic unemployment","latino unemployment","hispanic jobless","race unemployment hispanic"],
    national: { seriesIds: ["LNS14000009"], labels: ["Unemployment Rate, Hispanic (SA, %)"] }
  },
  {
    id: "unemp_rate_white",
    name: "Unemployment Rate: White",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for White workers",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["white unemployment","white jobless","race unemployment white"],
    national: { seriesIds: ["LNS14000003"], labels: ["Unemployment Rate, White (SA, %)"] }
  },
  {
    id: "unemp_rate_asian",
    name: "Unemployment Rate: Asian",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for Asian workers",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["asian unemployment","asian jobless","race unemployment asian"],
    national: { seriesIds: ["LNS14032183"], labels: ["Unemployment Rate, Asian (SA, %)"] }
  },
  {
    id: "unemp_rate_youth",
    name: "Unemployment Rate: Ages 16-24",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for young workers aged 16-24",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["youth unemployment","young unemployment","teen unemployment","16-24","young workers","youth jobless"],
    national: { seriesIds: ["LNS14024887"], labels: ["Unemployment Rate, 16-24 (SA, %)"] }
  },
  {
    id: "unemp_rate_edu_less_hs",
    name: "Unemployment Rate: Less Than High School",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for those with less than a high school diploma (25+)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["unemployment education","less than high school","no diploma","low education unemployment"],
    national: { seriesIds: ["LNS14027659"], labels: ["Unemp Rate, <High School, 25+ (SA, %)"] }
  },
  {
    id: "unemp_rate_edu_college",
    name: "Unemployment Rate: Bachelor's Degree and Higher",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Unemployment rate for those with a bachelor's degree or higher (25+)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["college unemployment","bachelor unemployment","degree unemployment","educated unemployment","college graduates"],
    national: { seriesIds: ["LNS14027662"], labels: ["Unemp Rate, Bachelor's+, 25+ (SA, %)"] }
  },
  // --- Median Usual Weekly Earnings ---
  {
    id: "median_weekly_earnings",
    name: "Median Usual Weekly Earnings",
    source: "CPS",
    sourceLabel: "Current Population Survey",
    description: "Median usual weekly earnings of full-time wage and salary workers",
    frequency: "Quarterly",
    stateLevel: false,
    keywords: ["median earnings","median weekly earnings","median wage","median income","median pay","usual weekly earnings"],
    national: { seriesIds: ["LEU0252881500"], labels: ["Median Weekly Earnings (SA, $)"] }
  },
  // --- Productivity ---
  {
    id: "labor_productivity",
    name: "Labor Productivity (Nonfarm Business)",
    source: "LPC",
    sourceLabel: "Labor Productivity and Costs",
    description: "Output per hour, nonfarm business sector (index, 2012=100)",
    frequency: "Quarterly",
    stateLevel: false,
    keywords: ["productivity","labor productivity","output per hour","worker productivity","nonfarm productivity","labour productivity"],
    national: { seriesIds: ["PRS85006092"], labels: ["Output Per Hour, Nonfarm Business (SA, 2012=100)"] }
  },
  {
    id: "unit_labor_costs",
    name: "Unit Labor Costs (Nonfarm Business)",
    source: "LPC",
    sourceLabel: "Labor Productivity and Costs",
    description: "Unit labor costs for nonfarm business sector (index, 2012=100)",
    frequency: "Quarterly",
    stateLevel: false,
    keywords: ["unit labor costs","ulc","unit labour costs","labor costs per unit","cost per unit of output"],
    national: { seriesIds: ["PRS85006112"], labels: ["Unit Labor Costs, Nonfarm Business (SA, 2012=100)"] }
  },
  // --- Work stoppages ---
  {
    id: "work_stoppages",
    name: "Major Work Stoppages",
    source: "WS",
    sourceLabel: "Work Stoppages",
    description: "Number of major work stoppages (strikes & lockouts involving 1,000+ workers)",
    frequency: "Annual",
    stateLevel: false,
    keywords: ["strikes","work stoppages","lockouts","labor disputes","strike","union strike"],
    national: { seriesIds: ["WSU001"], labels: ["Number of Major Work Stoppages"] }
  },
  {
    id: "insured_unemployment",
    name: "Insured Unemployment Rate",
    source: "LA",
    sourceLabel: "Unemployment Insurance",
    description: "Insured unemployment rate (state UI programs)",
    frequency: "Monthly",
    stateLevel: false,
    keywords: ["initial claims","unemployment claims","jobless claims","ui claims","unemployment insurance","insured unemployment"],
    national: { seriesIds: ["LIUR0000000"], labels: ["Insured Unemployment Rate"] }
  },
  // --- OEWS (occupational wages) ---
  {
    id: "oews_all_occupations",
    name: "All Occupations — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage across all occupations. Note: OEWS data is annual (released ~May each year for the prior year). State-level available.",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["occupational wages","oews","oes","occupation","occupational employment","mean wage","average salary","salary data","wage data","wages by occupation"],
    national: { seriesIds: ["OEUN000000000000000000004"], labels: ["Mean Annual Wage, All Occupations ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}0000000000000000004`],
      labels: ["Mean Annual Wage, All Occupations ($)"]
    })
  },
  {
    id: "oews_nurses",
    name: "Registered Nurses — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for Registered Nurses (SOC 29-1141)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["nurse wages","registered nurse","rn salary","nurse salary","nursing wages","nurse pay","nurses"],
    national: { seriesIds: ["OEUN000000000000029114100004"], labels: ["Mean Annual Wage, RNs ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000029114100004`],
      labels: ["Mean Annual Wage, RNs ($)"]
    })
  },
  {
    id: "oews_software_devs",
    name: "Software Developers — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for Software Developers (SOC 15-1252)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["software developer wages","software engineer salary","programmer wages","developer salary","software wages","tech wages","coder salary","software developers","software engineers"],
    national: { seriesIds: ["OEUN000000000000015125200004"], labels: ["Mean Annual Wage, Software Devs ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000015125200004`],
      labels: ["Mean Annual Wage, Software Devs ($)"]
    })
  },
  {
    id: "oews_teachers",
    name: "Elementary School Teachers — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for Elementary School Teachers (SOC 25-2021)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["teacher wages","teacher salary","elementary teacher","teacher pay","teachers","teaching salary"],
    national: { seriesIds: ["OEUN000000000000025202100004"], labels: ["Mean Annual Wage, Elem Teachers ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000025202100004`],
      labels: ["Mean Annual Wage, Elem Teachers ($)"]
    })
  },
  {
    id: "oews_accountants",
    name: "Accountants & Auditors — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for Accountants and Auditors (SOC 13-2011)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["accountant wages","accountant salary","auditor wages","accounting salary","cpa salary","accountants"],
    national: { seriesIds: ["OEUN000000000000013201100004"], labels: ["Mean Annual Wage, Accountants ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000013201100004`],
      labels: ["Mean Annual Wage, Accountants ($)"]
    })
  },
  {
    id: "oews_lawyers",
    name: "Lawyers — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for Lawyers (SOC 23-1011)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["lawyer wages","lawyer salary","attorney salary","legal wages","lawyers","attorney pay"],
    national: { seriesIds: ["OEUN000000000000023101100004"], labels: ["Mean Annual Wage, Lawyers ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000023101100004`],
      labels: ["Mean Annual Wage, Lawyers ($)"]
    })
  },
  {
    id: "oews_management",
    name: "Management Occupations — Wages (OEWS)",
    source: "OEWS",
    sourceLabel: "Occupational Employment & Wage Statistics",
    description: "Mean annual wage for management occupations (SOC 11-0000)",
    frequency: "Annual",
    stateLevel: true,
    keywords: ["management wages","manager salary","executive wages","management pay","managers","ceo salary","director salary"],
    national: { seriesIds: ["OEUN000000000000011000000004"], labels: ["Mean Annual Wage, Management ($)"] },
    state: (fips) => ({
      seriesIds: [`OEUS${fips}00000000011000000004`],
      labels: ["Mean Annual Wage, Management ($)"]
    })
  }
];

// ============================================================
// POPULATE STATE DROPDOWN
// ============================================================
(function populateStates() {
  const sel = document.getElementById('stateSelect');
  const sorted = Object.entries(STATE_NAMES).sort((a,b) => a[0].localeCompare(b[0]));
  sorted.forEach(([name, abbr]) => {
    const opt = document.createElement('option');
    opt.value = abbr;
    opt.textContent = name.replace(/\b\w/g, c => c.toUpperCase()) + ` (${abbr})`;
    sel.appendChild(opt);
  });
})();

// ============================================================
// SEARCH ENGINE
// ============================================================
function detectState(query) {
  const q = query.toLowerCase();
  for (const [name, abbr] of Object.entries(STATE_NAMES)) {
    if (q.includes(name)) return abbr;
  }
  const words = q.split(/\s+/);
  for (const w of words) {
    const upper = w.toUpperCase();
    if (STATES[upper]) return upper;
  }
  return null;
}

function scoreMatch(query, entry) {
  const q = query.toLowerCase();
  const tokens = q.split(/\s+/).filter(t => t.length > 1);
  let score = 0;

  if (q.includes(entry.name.toLowerCase())) score += 50;
  if (q.includes(entry.source.toLowerCase())) score += 20;

  for (const kw of entry.keywords) {
    if (q.includes(kw)) {
      score += 30;
    } else {
      const kwTokens = kw.split(/\s+/);
      for (const kt of kwTokens) {
        for (const qt of tokens) {
          if (kt.startsWith(qt) || qt.startsWith(kt)) score += 5;
          if (kt === qt) score += 15;
        }
      }
    }
  }

  for (const t of tokens) {
    if (entry.description.toLowerCase().includes(t)) score += 3;
  }

  return score;
}

function searchCatalog(query) {
  const scored = DATA_CATALOG.map(entry => ({
    entry,
    score: scoreMatch(query, entry)
  }));
  return scored
    .filter(s => s.score > 5)
    .sort((a,b) => b.score - a.score)
    .slice(0, 10)
    .map(s => s.entry);
}

// ============================================================
// BLS API CLIENT — calls our own /api/bls serverless function
// ============================================================
async function fetchBLSData(seriesIds, startYear, endYear) {
  const resp = await fetch('/api/bls', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      seriesid: seriesIds,
      startyear: String(startYear),
      endyear: String(endYear)
    })
  });

  if (!resp.ok) {
    const errBody = await resp.json().catch(() => ({}));
    throw new Error(errBody.error || `Server returned HTTP ${resp.status}`);
  }

  const json = await resp.json();

  if (json.status !== 'REQUEST_SUCCEEDED') {
    const msgs = json.message || [];
    throw new Error(`BLS API error: ${msgs.join('; ') || 'Unknown error'}`);
  }

  return json.Results.series;
}

// ============================================================
// UI RENDERING
// ============================================================
let matchCounter = 0;
const cardConfigs = {};

function runSearch() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return;

  let stateAbbr = document.getElementById('stateSelect').value;
  const detectedState = detectState(query);
  if (detectedState && !stateAbbr) {
    stateAbbr = detectedState;
    document.getElementById('stateSelect').value = detectedState;
  }

  const stateFips = stateAbbr ? STATES[stateAbbr] : null;
  const matches = searchCatalog(query);

  const area = document.getElementById('resultsArea');

  if (matches.length === 0) {
    area.innerHTML = `
      <div class="empty-state">
        <div class="icon">&#128533;</div>
        <p>No matching data series found. Try different keywords.</p>
        <p style="font-size:0.85rem;color:var(--gray-400);margin-top:0.5rem;">
          Examples: "unemployment rate", "average wages", "CPI inflation", "job openings"
        </p>
      </div>`;
    return;
  }

  let html = `<div class="results-header"><h2>${matches.length} matching data series</h2></div>`;

  if (stateFips) {
    const stateName = Object.entries(STATE_NAMES).find(([n,a]) => a === stateAbbr);
    html += `<div class="info-box">Showing state-level data for <strong>${stateName ? stateName[0].replace(/\b\w/g, c => c.toUpperCase()) : stateAbbr}</strong> where available. Series without state data will show national figures.</div>`;
  }

  for (const match of matches) {
    const useState = stateFips && match.stateLevel && match.state;
    const config = useState ? match.state(stateFips) : match.national;
    if (!config) continue;

    const cardId = `card-${++matchCounter}`;
    cardConfigs[cardId] = { seriesIds: config.seriesIds, labels: config.labels };

    html += `
      <div class="match-card" id="${cardId}">
        <div class="match-card-header" onclick="togglePanel('${cardId}')">
          <div class="match-info">
            <h3>${match.name}</h3>
            <p>${match.description}</p>
            <div class="series-id-display">Series: ${config.seriesIds.join(', ')}</div>
          </div>
          <div style="display:flex;align-items:center;">
            <div class="match-badges">
              <span class="badge badge-source">${match.source}</span>
              <span class="badge badge-freq">${match.frequency}</span>
              ${useState ? '<span class="badge badge-geo">State</span>' : '<span class="badge badge-geo">National</span>'}
            </div>
            <button class="btn-fetch" onclick="event.stopPropagation(); fetchFromCard('${cardId}')">
              Fetch Data
            </button>
          </div>
        </div>
        <div class="data-panel" id="panel-${cardId}"></div>
      </div>`;
  }

  area.innerHTML = html;
}

function togglePanel(cardId) {
  const panel = document.getElementById(`panel-${cardId}`);
  if (panel) panel.classList.toggle('open');
}

function fetchFromCard(cardId) {
  const cfg = cardConfigs[cardId];
  if (cfg) fetchAndShow(cardId, cfg.seriesIds, cfg.labels);
}

async function fetchAndShow(cardId, seriesIds, labels) {
  const panel = document.getElementById(`panel-${cardId}`);
  const startYear = parseInt(document.getElementById('startYear').value);
  const endYear = parseInt(document.getElementById('endYear').value);

  panel.classList.add('open');
  panel.innerHTML = '<div class="loading"><div class="spinner"></div><br>Fetching data from BLS...</div>';

  const btn = panel.parentElement.querySelector('.btn-fetch');
  if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }

  try {
    const seriesData = await fetchBLSData(seriesIds, startYear, endYear);

    if (!seriesData || seriesData.length === 0) {
      panel.innerHTML = '<div class="error-msg">No data returned. The series may not exist for this time range or geography.</div>';
      if (btn) { btn.disabled = false; btn.textContent = 'Retry'; }
      return;
    }

    const rows = [];
    seriesData.forEach((s, idx) => {
      const label = labels[idx] || s.seriesID;
      s.data.forEach(d => {
        rows.push({
          seriesId: s.seriesID,
          label: label,
          year: d.year,
          period: d.period,
          periodName: d.periodName,
          value: d.value,
          footnotes: (d.footnotes || []).map(f => f.text).filter(Boolean).join('; ')
        });
      });
    });

    rows.sort((a,b) => {
      if (a.year !== b.year) return b.year.localeCompare(a.year);
      return b.period.localeCompare(a.period);
    });

    const tableId = `table-${cardId}`;

    let tableHtml = `
      <div class="data-panel-controls">
        <span style="font-size:0.82rem;color:var(--gray-500);">${rows.length} observations</span>
        <button class="btn-csv" onclick="exportCSV('${tableId}')">Export CSV</button>
      </div>
      <div class="data-table-wrapper">
        <table class="data-table" id="${tableId}">
          <thead>
            <tr>
              <th onclick="sortTable('${tableId}', 0)">Year</th>
              <th onclick="sortTable('${tableId}', 1)">Period</th>
              <th onclick="sortTable('${tableId}', 2)">Value</th>
              ${seriesData.length > 1 ? `<th onclick="sortTable('${tableId}', 3)">Series</th>` : ''}
              <th>Footnotes</th>
            </tr>
          </thead>
          <tbody>`;

    for (const row of rows) {
      const numVal = parseFloat(row.value);
      const formattedVal = isNaN(numVal) ? row.value : numVal.toLocaleString('en-US', { maximumFractionDigits: 2 });
      tableHtml += `
        <tr>
          <td>${row.year}</td>
          <td>${row.periodName}</td>
          <td style="text-align:right;font-weight:500;">${formattedVal}</td>
          ${seriesData.length > 1 ? `<td style="font-size:0.8rem;">${row.label}</td>` : ''}
          <td style="font-size:0.8rem;color:var(--gray-400);">${row.footnotes || ''}</td>
        </tr>`;
    }

    tableHtml += '</tbody></table></div>';
    panel.innerHTML = tableHtml;
    if (btn) { btn.disabled = false; btn.textContent = 'Refresh'; }

  } catch (err) {
    panel.innerHTML = `<div class="error-msg">Error: ${err.message}</div>`;
    if (btn) { btn.disabled = false; btn.textContent = 'Retry'; }
  }
}

// ============================================================
// TABLE SORTING
// ============================================================
const sortState = {};

function sortTable(tableId, colIdx) {
  const table = document.getElementById(tableId);
  if (!table) return;

  const key = `${tableId}-${colIdx}`;
  sortState[key] = sortState[key] === 'asc' ? 'desc' : 'asc';
  const dir = sortState[key];

  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));

  rows.sort((a, b) => {
    const aVal = a.cells[colIdx]?.textContent.trim() || '';
    const bVal = b.cells[colIdx]?.textContent.trim() || '';
    const aNum = parseFloat(aVal.replace(/,/g, ''));
    const bNum = parseFloat(bVal.replace(/,/g, ''));

    if (!isNaN(aNum) && !isNaN(bNum)) {
      return dir === 'asc' ? aNum - bNum : bNum - aNum;
    }
    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
  });

  rows.forEach(r => tbody.appendChild(r));
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;

  const rows = Array.from(table.querySelectorAll('tr'));
  const csvLines = rows.map(row => {
    const cells = Array.from(row.querySelectorAll('th, td'));
    return cells.map(c => `"${c.textContent.trim().replace(/"/g, '""')}"`).join(',');
  });

  const blob = new Blob([csvLines.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `bls_data_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// QUICK SEARCH & ENTER KEY
// ============================================================
function quickSearch(text) {
  document.getElementById('searchInput').value = text;
  runSearch();
}

document.getElementById('searchInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') runSearch();
});
</script>

</body>
</html>